<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Data URL example: /index.html?data={"tile":"NO_LABEL_OSM","geoinfo":{"USER":[22.3,114.3],"ITEM_1":[22.2,114.2]}} -->
    
    <script>
        // Function to extract data from URL
        function getDataFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            return data ? JSON.parse(decodeURIComponent(data)) : null;
        }

        // Initialize the map
        const map = L.map('map').setView([22.3, 114.3], 12);

        // Define icon mapping
        const iconMap = {
            "USER": "./image/USER.PNG",
            "KEY": "./image/KEY.PNG",
            "ITEM_1": "./image/ITEM-1.PNG",
            "ITEM_2": "./image/ITEM-2.PNG",
            "ITEM_3": "./image/ITEM-3.PNG",
            "ITEM_4": "./image/ITEM-4.PNG",
            "ITEM_5": "./image/ITEM-5.PNG"
        };

        // Function to add markers to the map
        function addMarkers(data) {
            const bounds = L.latLngBounds(); // Create a bounds object

            for (const [key, coordinates] of Object.entries(data.geoinfo)) {
                const iconUrl = iconMap[key] || "";
                if (iconUrl) {
                    const customIcon = L.icon({
                        iconUrl: iconUrl,
                        iconSize: [38, 38] // Adjust size as needed
                    });

                    const marker = L.marker(coordinates, { icon: customIcon }).addTo(map)
                        .bindPopup(key);
                    
                    bounds.extend(marker.getLatLng()); // Extend the bounds to include the marker
                }
            }

            // Fit the map to the bounds of the markers
            map.fitBounds(bounds);
        }

        // Get data and set up the tile layer
        const data = getDataFromUrl();
        let tileURL;

        // Determine the tile URL based on the data
        if (data) {
            switch(data.tile) {
                case "LABELED":
                    tileURL = `https://tile.openstreetmap.org/{z}/{x}/{y}.png`;
                    break;
                case "SATELLITE":
                    tileURL = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}`;
                    break;
                default:
					tileURL = `https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png`;
                    break;
            }

            // Set up the tile layer
            L.tileLayer(tileURL, {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add markers to the map
            addMarkers(data);
        }
    </script>
</body>
</html>
